var Ne=Object.defineProperty;var xe=(s,e,t)=>e in s?Ne(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var d=(s,e,t)=>xe(s,typeof e!="symbol"?e+"":e,t);import{E as f,L as x,Q as O}from"./index-y7ty4Tjl.js";async function Oe(s,e=3,t=1e3){let i=1;for(;i<=e;)try{return await s()}catch(n){if(i++,i>e)throw new Error(n instanceof Error?n.message:`Failed to perform action after ${e} attempts`);await new Promise(r=>setTimeout(r,t))}throw new Error("Unreachable code")}const b=Object.create(null);b.open="0";b.close="1";b.ping="2";b.pong="3";b.message="4";b.upgrade="5";b.noop="6";const U=Object.create(null);Object.keys(b).forEach(s=>{U[b[s]]=s});const z={type:"error",data:"parser error"},pe=typeof Blob=="function"||typeof Blob<"u"&&Object.prototype.toString.call(Blob)==="[object BlobConstructor]",me=typeof ArrayBuffer=="function",ge=s=>typeof ArrayBuffer.isView=="function"?ArrayBuffer.isView(s):s&&s.buffer instanceof ArrayBuffer,G=({type:s,data:e},t,i)=>pe&&e instanceof Blob?t?i(e):ae(e,i):me&&(e instanceof ArrayBuffer||ge(e))?t?i(e):ae(new Blob([e]),i):i(b[s]+(e||"")),ae=(s,e)=>{const t=new FileReader;return t.onload=function(){const i=t.result.split(",")[1];e("b"+(i||""))},t.readAsDataURL(s)};function ce(s){return s instanceof Uint8Array?s:s instanceof ArrayBuffer?new Uint8Array(s):new Uint8Array(s.buffer,s.byteOffset,s.byteLength)}let $;function Me(s,e){if(pe&&s.data instanceof Blob)return s.data.arrayBuffer().then(ce).then(e);if(me&&(s.data instanceof ArrayBuffer||ge(s.data)))return e(ce(s.data));G(s,!1,t=>{$||($=new TextEncoder),e($.encode(t))})}const he="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",A=typeof Uint8Array>"u"?[]:new Uint8Array(256);for(let s=0;s<he.length;s++)A[he.charCodeAt(s)]=s;const Ie=s=>{let e=s.length*.75,t=s.length,i,n=0,r,o,a,c;s[s.length-1]==="="&&(e--,s[s.length-2]==="="&&e--);const p=new ArrayBuffer(e),u=new Uint8Array(p);for(i=0;i<t;i+=4)r=A[s.charCodeAt(i)],o=A[s.charCodeAt(i+1)],a=A[s.charCodeAt(i+2)],c=A[s.charCodeAt(i+3)],u[n++]=r<<2|o>>4,u[n++]=(o&15)<<4|a>>2,u[n++]=(a&3)<<6|c&63;return p},Be=typeof ArrayBuffer=="function",Q=(s,e)=>{if(typeof s!="string")return{type:"message",data:ye(s,e)};const t=s.charAt(0);return t==="b"?{type:"message",data:Ue(s.substring(1),e)}:U[t]?s.length>1?{type:U[t],data:s.substring(1)}:{type:U[t]}:z},Ue=(s,e)=>{if(Be){const t=Ie(s);return ye(t,e)}else return{base64:!0,data:s}},ye=(s,e)=>{switch(e){case"blob":return s instanceof Blob?s:new Blob([s]);case"arraybuffer":default:return s instanceof ArrayBuffer?s:s.buffer}},_e="",Pe=(s,e)=>{const t=s.length,i=new Array(t);let n=0;s.forEach((r,o)=>{G(r,!1,a=>{i[o]=a,++n===t&&e(i.join(_e))})})},De=(s,e)=>{const t=s.split(_e),i=[];for(let n=0;n<t.length;n++){const r=Q(t[n],e);if(i.push(r),r.type==="error")break}return i};function qe(){return new TransformStream({transform(s,e){Me(s,t=>{const i=t.length;let n;if(i<126)n=new Uint8Array(1),new DataView(n.buffer).setUint8(0,i);else if(i<65536){n=new Uint8Array(3);const r=new DataView(n.buffer);r.setUint8(0,126),r.setUint16(1,i)}else{n=new Uint8Array(9);const r=new DataView(n.buffer);r.setUint8(0,127),r.setBigUint64(1,BigInt(i))}s.data&&typeof s.data!="string"&&(n[0]|=128),e.enqueue(n),e.enqueue(t)})}})}let V;function M(s){return s.reduce((e,t)=>e+t.length,0)}function I(s,e){if(s[0].length===e)return s.shift();const t=new Uint8Array(e);let i=0;for(let n=0;n<e;n++)t[n]=s[0][i++],i===s[0].length&&(s.shift(),i=0);return s.length&&i<s[0].length&&(s[0]=s[0].slice(i)),t}function Fe(s,e){V||(V=new TextDecoder);const t=[];let i=0,n=-1,r=!1;return new TransformStream({transform(o,a){for(t.push(o);;){if(i===0){if(M(t)<1)break;const c=I(t,1);r=(c[0]&128)===128,n=c[0]&127,n<126?i=3:n===126?i=1:i=2}else if(i===1){if(M(t)<2)break;const c=I(t,2);n=new DataView(c.buffer,c.byteOffset,c.length).getUint16(0),i=3}else if(i===2){if(M(t)<8)break;const c=I(t,8),p=new DataView(c.buffer,c.byteOffset,c.length),u=p.getUint32(0);if(u>Math.pow(2,21)-1){a.enqueue(z);break}n=u*Math.pow(2,32)+p.getUint32(4),i=3}else{if(M(t)<n)break;const c=I(t,n);a.enqueue(Q(r?c:V.decode(c),e)),i=0}if(n===0||n>s){a.enqueue(z);break}}}})}const ve=4;function l(s){if(s)return He(s)}function He(s){for(var e in l.prototype)s[e]=l.prototype[e];return s}l.prototype.on=l.prototype.addEventListener=function(s,e){return this._callbacks=this._callbacks||{},(this._callbacks["$"+s]=this._callbacks["$"+s]||[]).push(e),this};l.prototype.once=function(s,e){function t(){this.off(s,t),e.apply(this,arguments)}return t.fn=e,this.on(s,t),this};l.prototype.off=l.prototype.removeListener=l.prototype.removeAllListeners=l.prototype.removeEventListener=function(s,e){if(this._callbacks=this._callbacks||{},arguments.length==0)return this._callbacks={},this;var t=this._callbacks["$"+s];if(!t)return this;if(arguments.length==1)return delete this._callbacks["$"+s],this;for(var i,n=0;n<t.length;n++)if(i=t[n],i===e||i.fn===e){t.splice(n,1);break}return t.length===0&&delete this._callbacks["$"+s],this};l.prototype.emit=function(s){this._callbacks=this._callbacks||{};for(var e=new Array(arguments.length-1),t=this._callbacks["$"+s],i=1;i<arguments.length;i++)e[i-1]=arguments[i];if(t){t=t.slice(0);for(var i=0,n=t.length;i<n;++i)t[i].apply(this,e)}return this};l.prototype.emitReserved=l.prototype.emit;l.prototype.listeners=function(s){return this._callbacks=this._callbacks||{},this._callbacks["$"+s]||[]};l.prototype.hasListeners=function(s){return!!this.listeners(s).length};const F=typeof Promise=="function"&&typeof Promise.resolve=="function"?e=>Promise.resolve().then(e):(e,t)=>t(e,0),y=typeof self<"u"?self:typeof window<"u"?window:Function("return this")(),$e="arraybuffer";function be(s,...e){return e.reduce((t,i)=>(s.hasOwnProperty(i)&&(t[i]=s[i]),t),{})}const Ve=y.setTimeout,We=y.clearTimeout;function H(s,e){e.useNativeTimers?(s.setTimeoutFn=Ve.bind(y),s.clearTimeoutFn=We.bind(y)):(s.setTimeoutFn=y.setTimeout.bind(y),s.clearTimeoutFn=y.clearTimeout.bind(y))}const ze=1.33;function Ye(s){return typeof s=="string"?je(s):Math.ceil((s.byteLength||s.size)*ze)}function je(s){let e=0,t=0;for(let i=0,n=s.length;i<n;i++)e=s.charCodeAt(i),e<128?t+=1:e<2048?t+=2:e<55296||e>=57344?t+=3:(i++,t+=4);return t}function we(){return Date.now().toString(36).substring(3)+Math.random().toString(36).substring(2,5)}function Je(s){let e="";for(let t in s)s.hasOwnProperty(t)&&(e.length&&(e+="&"),e+=encodeURIComponent(t)+"="+encodeURIComponent(s[t]));return e}function Ke(s){let e={},t=s.split("&");for(let i=0,n=t.length;i<n;i++){let r=t[i].split("=");e[decodeURIComponent(r[0])]=decodeURIComponent(r[1])}return e}class Xe extends Error{constructor(e,t,i){super(e),this.description=t,this.context=i,this.type="TransportError"}}class Z extends l{constructor(e){super(),this.writable=!1,H(this,e),this.opts=e,this.query=e.query,this.socket=e.socket,this.supportsBinary=!e.forceBase64}onError(e,t,i){return super.emitReserved("error",new Xe(e,t,i)),this}open(){return this.readyState="opening",this.doOpen(),this}close(){return(this.readyState==="opening"||this.readyState==="open")&&(this.doClose(),this.onClose()),this}send(e){this.readyState==="open"&&this.write(e)}onOpen(){this.readyState="open",this.writable=!0,super.emitReserved("open")}onData(e){const t=Q(e,this.socket.binaryType);this.onPacket(t)}onPacket(e){super.emitReserved("packet",e)}onClose(e){this.readyState="closed",super.emitReserved("close",e)}pause(e){}createUri(e,t={}){return e+"://"+this._hostname()+this._port()+this.opts.path+this._query(t)}_hostname(){const e=this.opts.hostname;return e.indexOf(":")===-1?e:"["+e+"]"}_port(){return this.opts.port&&(this.opts.secure&&+(this.opts.port!==443)||!this.opts.secure&&Number(this.opts.port)!==80)?":"+this.opts.port:""}_query(e){const t=Je(e);return t.length?"?"+t:""}}class Ge extends Z{constructor(){super(...arguments),this._polling=!1}get name(){return"polling"}doOpen(){this._poll()}pause(e){this.readyState="pausing";const t=()=>{this.readyState="paused",e()};if(this._polling||!this.writable){let i=0;this._polling&&(i++,this.once("pollComplete",function(){--i||t()})),this.writable||(i++,this.once("drain",function(){--i||t()}))}else t()}_poll(){this._polling=!0,this.doPoll(),this.emitReserved("poll")}onData(e){const t=i=>{if(this.readyState==="opening"&&i.type==="open"&&this.onOpen(),i.type==="close")return this.onClose({description:"transport closed by the server"}),!1;this.onPacket(i)};De(e,this.socket.binaryType).forEach(t),this.readyState!=="closed"&&(this._polling=!1,this.emitReserved("pollComplete"),this.readyState==="open"&&this._poll())}doClose(){const e=()=>{this.write([{type:"close"}])};this.readyState==="open"?e():this.once("open",e)}write(e){this.writable=!1,Pe(e,t=>{this.doWrite(t,()=>{this.writable=!0,this.emitReserved("drain")})})}uri(){const e=this.opts.secure?"https":"http",t=this.query||{};return this.opts.timestampRequests!==!1&&(t[this.opts.timestampParam]=we()),!this.supportsBinary&&!t.sid&&(t.b64=1),this.createUri(e,t)}}let Ee=!1;try{Ee=typeof XMLHttpRequest<"u"&&"withCredentials"in new XMLHttpRequest}catch{}const Qe=Ee;function Ze(){}class et extends Ge{constructor(e){if(super(e),typeof location<"u"){const t=location.protocol==="https:";let i=location.port;i||(i=t?"443":"80"),this.xd=typeof location<"u"&&e.hostname!==location.hostname||i!==e.port}}doWrite(e,t){const i=this.request({method:"POST",data:e});i.on("success",t),i.on("error",(n,r)=>{this.onError("xhr post error",n,r)})}doPoll(){const e=this.request();e.on("data",this.onData.bind(this)),e.on("error",(t,i)=>{this.onError("xhr poll error",t,i)}),this.pollXhr=e}}class v extends l{constructor(e,t,i){super(),this.createRequest=e,H(this,i),this._opts=i,this._method=i.method||"GET",this._uri=t,this._data=i.data!==void 0?i.data:null,this._create()}_create(){var e;const t=be(this._opts,"agent","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","autoUnref");t.xdomain=!!this._opts.xd;const i=this._xhr=this.createRequest(t);try{i.open(this._method,this._uri,!0);try{if(this._opts.extraHeaders){i.setDisableHeaderCheck&&i.setDisableHeaderCheck(!0);for(let n in this._opts.extraHeaders)this._opts.extraHeaders.hasOwnProperty(n)&&i.setRequestHeader(n,this._opts.extraHeaders[n])}}catch{}if(this._method==="POST")try{i.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch{}try{i.setRequestHeader("Accept","*/*")}catch{}(e=this._opts.cookieJar)===null||e===void 0||e.addCookies(i),"withCredentials"in i&&(i.withCredentials=this._opts.withCredentials),this._opts.requestTimeout&&(i.timeout=this._opts.requestTimeout),i.onreadystatechange=()=>{var n;i.readyState===3&&((n=this._opts.cookieJar)===null||n===void 0||n.parseCookies(i.getResponseHeader("set-cookie"))),i.readyState===4&&(i.status===200||i.status===1223?this._onLoad():this.setTimeoutFn(()=>{this._onError(typeof i.status=="number"?i.status:0)},0))},i.send(this._data)}catch(n){this.setTimeoutFn(()=>{this._onError(n)},0);return}typeof document<"u"&&(this._index=v.requestsCount++,v.requests[this._index]=this)}_onError(e){this.emitReserved("error",e,this._xhr),this._cleanup(!0)}_cleanup(e){if(!(typeof this._xhr>"u"||this._xhr===null)){if(this._xhr.onreadystatechange=Ze,e)try{this._xhr.abort()}catch{}typeof document<"u"&&delete v.requests[this._index],this._xhr=null}}_onLoad(){const e=this._xhr.responseText;e!==null&&(this.emitReserved("data",e),this.emitReserved("success"),this._cleanup())}abort(){this._cleanup()}}v.requestsCount=0;v.requests={};if(typeof document<"u"){if(typeof attachEvent=="function")attachEvent("onunload",de);else if(typeof addEventListener=="function"){const s="onpagehide"in y?"pagehide":"unload";addEventListener(s,de,!1)}}function de(){for(let s in v.requests)v.requests.hasOwnProperty(s)&&v.requests[s].abort()}const tt=function(){const s=Ce({xdomain:!1});return s&&s.responseType!==null}();class it extends et{constructor(e){super(e);const t=e&&e.forceBase64;this.supportsBinary=tt&&!t}request(e={}){return Object.assign(e,{xd:this.xd},this.opts),new v(Ce,this.uri(),e)}}function Ce(s){const e=s.xdomain;try{if(typeof XMLHttpRequest<"u"&&(!e||Qe))return new XMLHttpRequest}catch{}if(!e)try{return new y[["Active"].concat("Object").join("X")]("Microsoft.XMLHTTP")}catch{}}const ke=typeof navigator<"u"&&typeof navigator.product=="string"&&navigator.product.toLowerCase()==="reactnative";class st extends Z{get name(){return"websocket"}doOpen(){const e=this.uri(),t=this.opts.protocols,i=ke?{}:be(this.opts,"agent","perMessageDeflate","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","localAddress","protocolVersion","origin","maxPayload","family","checkServerIdentity");this.opts.extraHeaders&&(i.headers=this.opts.extraHeaders);try{this.ws=this.createSocket(e,t,i)}catch(n){return this.emitReserved("error",n)}this.ws.binaryType=this.socket.binaryType,this.addEventListeners()}addEventListeners(){this.ws.onopen=()=>{this.opts.autoUnref&&this.ws._socket.unref(),this.onOpen()},this.ws.onclose=e=>this.onClose({description:"websocket connection closed",context:e}),this.ws.onmessage=e=>this.onData(e.data),this.ws.onerror=e=>this.onError("websocket error",e)}write(e){this.writable=!1;for(let t=0;t<e.length;t++){const i=e[t],n=t===e.length-1;G(i,this.supportsBinary,r=>{try{this.doWrite(i,r)}catch{}n&&F(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})}}doClose(){typeof this.ws<"u"&&(this.ws.onerror=()=>{},this.ws.close(),this.ws=null)}uri(){const e=this.opts.secure?"wss":"ws",t=this.query||{};return this.opts.timestampRequests&&(t[this.opts.timestampParam]=we()),this.supportsBinary||(t.b64=1),this.createUri(e,t)}}const W=y.WebSocket||y.MozWebSocket;class nt extends st{createSocket(e,t,i){return ke?new W(e,t,i):t?new W(e,t):new W(e)}doWrite(e,t){this.ws.send(t)}}class rt extends Z{get name(){return"webtransport"}doOpen(){try{this._transport=new WebTransport(this.createUri("https"),this.opts.transportOptions[this.name])}catch(e){return this.emitReserved("error",e)}this._transport.closed.then(()=>{this.onClose()}).catch(e=>{this.onError("webtransport error",e)}),this._transport.ready.then(()=>{this._transport.createBidirectionalStream().then(e=>{const t=Fe(Number.MAX_SAFE_INTEGER,this.socket.binaryType),i=e.readable.pipeThrough(t).getReader(),n=qe();n.readable.pipeTo(e.writable),this._writer=n.writable.getWriter();const r=()=>{i.read().then(({done:a,value:c})=>{a||(this.onPacket(c),r())}).catch(a=>{})};r();const o={type:"open"};this.query.sid&&(o.data=`{"sid":"${this.query.sid}"}`),this._writer.write(o).then(()=>this.onOpen())})})}write(e){this.writable=!1;for(let t=0;t<e.length;t++){const i=e[t],n=t===e.length-1;this._writer.write(i).then(()=>{n&&F(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})}}doClose(){var e;(e=this._transport)===null||e===void 0||e.close()}}const ot={websocket:nt,webtransport:rt,polling:it},at=/^(?:(?![^:@\/?#]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@\/?#]*)(?::([^:@\/?#]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,ct=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];function Y(s){if(s.length>8e3)throw"URI too long";const e=s,t=s.indexOf("["),i=s.indexOf("]");t!=-1&&i!=-1&&(s=s.substring(0,t)+s.substring(t,i).replace(/:/g,";")+s.substring(i,s.length));let n=at.exec(s||""),r={},o=14;for(;o--;)r[ct[o]]=n[o]||"";return t!=-1&&i!=-1&&(r.source=e,r.host=r.host.substring(1,r.host.length-1).replace(/;/g,":"),r.authority=r.authority.replace("[","").replace("]","").replace(/;/g,":"),r.ipv6uri=!0),r.pathNames=ht(r,r.path),r.queryKey=dt(r,r.query),r}function ht(s,e){const t=/\/{2,9}/g,i=e.replace(t,"/").split("/");return(e.slice(0,1)=="/"||e.length===0)&&i.splice(0,1),e.slice(-1)=="/"&&i.splice(i.length-1,1),i}function dt(s,e){const t={};return e.replace(/(?:^|&)([^&=]*)=?([^&]*)/g,function(i,n,r){n&&(t[n]=r)}),t}const j=typeof addEventListener=="function"&&typeof removeEventListener=="function",P=[];j&&addEventListener("offline",()=>{P.forEach(s=>s())},!1);class E extends l{constructor(e,t){if(super(),this.binaryType=$e,this.writeBuffer=[],this._prevBufferLen=0,this._pingInterval=-1,this._pingTimeout=-1,this._maxPayload=-1,this._pingTimeoutTime=1/0,e&&typeof e=="object"&&(t=e,e=null),e){const i=Y(e);t.hostname=i.host,t.secure=i.protocol==="https"||i.protocol==="wss",t.port=i.port,i.query&&(t.query=i.query)}else t.host&&(t.hostname=Y(t.host).host);H(this,t),this.secure=t.secure!=null?t.secure:typeof location<"u"&&location.protocol==="https:",t.hostname&&!t.port&&(t.port=this.secure?"443":"80"),this.hostname=t.hostname||(typeof location<"u"?location.hostname:"localhost"),this.port=t.port||(typeof location<"u"&&location.port?location.port:this.secure?"443":"80"),this.transports=[],this._transportsByName={},t.transports.forEach(i=>{const n=i.prototype.name;this.transports.push(n),this._transportsByName[n]=i}),this.opts=Object.assign({path:"/engine.io",agent:!1,withCredentials:!1,upgrade:!0,timestampParam:"t",rememberUpgrade:!1,addTrailingSlash:!0,rejectUnauthorized:!0,perMessageDeflate:{threshold:1024},transportOptions:{},closeOnBeforeunload:!1},t),this.opts.path=this.opts.path.replace(/\/$/,"")+(this.opts.addTrailingSlash?"/":""),typeof this.opts.query=="string"&&(this.opts.query=Ke(this.opts.query)),j&&(this.opts.closeOnBeforeunload&&(this._beforeunloadEventListener=()=>{this.transport&&(this.transport.removeAllListeners(),this.transport.close())},addEventListener("beforeunload",this._beforeunloadEventListener,!1)),this.hostname!=="localhost"&&(this._offlineEventListener=()=>{this._onClose("transport close",{description:"network connection lost"})},P.push(this._offlineEventListener))),this.opts.withCredentials&&(this._cookieJar=void 0),this._open()}createTransport(e){const t=Object.assign({},this.opts.query);t.EIO=ve,t.transport=e,this.id&&(t.sid=this.id);const i=Object.assign({},this.opts,{query:t,socket:this,hostname:this.hostname,secure:this.secure,port:this.port},this.opts.transportOptions[e]);return new this._transportsByName[e](i)}_open(){if(this.transports.length===0){this.setTimeoutFn(()=>{this.emitReserved("error","No transports available")},0);return}const e=this.opts.rememberUpgrade&&E.priorWebsocketSuccess&&this.transports.indexOf("websocket")!==-1?"websocket":this.transports[0];this.readyState="opening";const t=this.createTransport(e);t.open(),this.setTransport(t)}setTransport(e){this.transport&&this.transport.removeAllListeners(),this.transport=e,e.on("drain",this._onDrain.bind(this)).on("packet",this._onPacket.bind(this)).on("error",this._onError.bind(this)).on("close",t=>this._onClose("transport close",t))}onOpen(){this.readyState="open",E.priorWebsocketSuccess=this.transport.name==="websocket",this.emitReserved("open"),this.flush()}_onPacket(e){if(this.readyState==="opening"||this.readyState==="open"||this.readyState==="closing")switch(this.emitReserved("packet",e),this.emitReserved("heartbeat"),e.type){case"open":this.onHandshake(JSON.parse(e.data));break;case"ping":this._sendPacket("pong"),this.emitReserved("ping"),this.emitReserved("pong"),this._resetPingTimeout();break;case"error":const t=new Error("server error");t.code=e.data,this._onError(t);break;case"message":this.emitReserved("data",e.data),this.emitReserved("message",e.data);break}}onHandshake(e){this.emitReserved("handshake",e),this.id=e.sid,this.transport.query.sid=e.sid,this._pingInterval=e.pingInterval,this._pingTimeout=e.pingTimeout,this._maxPayload=e.maxPayload,this.onOpen(),this.readyState!=="closed"&&this._resetPingTimeout()}_resetPingTimeout(){this.clearTimeoutFn(this._pingTimeoutTimer);const e=this._pingInterval+this._pingTimeout;this._pingTimeoutTime=Date.now()+e,this._pingTimeoutTimer=this.setTimeoutFn(()=>{this._onClose("ping timeout")},e),this.opts.autoUnref&&this._pingTimeoutTimer.unref()}_onDrain(){this.writeBuffer.splice(0,this._prevBufferLen),this._prevBufferLen=0,this.writeBuffer.length===0?this.emitReserved("drain"):this.flush()}flush(){if(this.readyState!=="closed"&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length){const e=this._getWritablePackets();this.transport.send(e),this._prevBufferLen=e.length,this.emitReserved("flush")}}_getWritablePackets(){if(!(this._maxPayload&&this.transport.name==="polling"&&this.writeBuffer.length>1))return this.writeBuffer;let t=1;for(let i=0;i<this.writeBuffer.length;i++){const n=this.writeBuffer[i].data;if(n&&(t+=Ye(n)),i>0&&t>this._maxPayload)return this.writeBuffer.slice(0,i);t+=2}return this.writeBuffer}_hasPingExpired(){if(!this._pingTimeoutTime)return!0;const e=Date.now()>this._pingTimeoutTime;return e&&(this._pingTimeoutTime=0,F(()=>{this._onClose("ping timeout")},this.setTimeoutFn)),e}write(e,t,i){return this._sendPacket("message",e,t,i),this}send(e,t,i){return this._sendPacket("message",e,t,i),this}_sendPacket(e,t,i,n){if(typeof t=="function"&&(n=t,t=void 0),typeof i=="function"&&(n=i,i=null),this.readyState==="closing"||this.readyState==="closed")return;i=i||{},i.compress=i.compress!==!1;const r={type:e,data:t,options:i};this.emitReserved("packetCreate",r),this.writeBuffer.push(r),n&&this.once("flush",n),this.flush()}close(){const e=()=>{this._onClose("forced close"),this.transport.close()},t=()=>{this.off("upgrade",t),this.off("upgradeError",t),e()},i=()=>{this.once("upgrade",t),this.once("upgradeError",t)};return(this.readyState==="opening"||this.readyState==="open")&&(this.readyState="closing",this.writeBuffer.length?this.once("drain",()=>{this.upgrading?i():e()}):this.upgrading?i():e()),this}_onError(e){if(E.priorWebsocketSuccess=!1,this.opts.tryAllTransports&&this.transports.length>1&&this.readyState==="opening")return this.transports.shift(),this._open();this.emitReserved("error",e),this._onClose("transport error",e)}_onClose(e,t){if(this.readyState==="opening"||this.readyState==="open"||this.readyState==="closing"){if(this.clearTimeoutFn(this._pingTimeoutTimer),this.transport.removeAllListeners("close"),this.transport.close(),this.transport.removeAllListeners(),j&&(this._beforeunloadEventListener&&removeEventListener("beforeunload",this._beforeunloadEventListener,!1),this._offlineEventListener)){const i=P.indexOf(this._offlineEventListener);i!==-1&&P.splice(i,1)}this.readyState="closed",this.id=null,this.emitReserved("close",e,t),this.writeBuffer=[],this._prevBufferLen=0}}}E.protocol=ve;class lt extends E{constructor(){super(...arguments),this._upgrades=[]}onOpen(){if(super.onOpen(),this.readyState==="open"&&this.opts.upgrade)for(let e=0;e<this._upgrades.length;e++)this._probe(this._upgrades[e])}_probe(e){let t=this.createTransport(e),i=!1;E.priorWebsocketSuccess=!1;const n=()=>{i||(t.send([{type:"ping",data:"probe"}]),t.once("packet",m=>{if(!i)if(m.type==="pong"&&m.data==="probe"){if(this.upgrading=!0,this.emitReserved("upgrading",t),!t)return;E.priorWebsocketSuccess=t.name==="websocket",this.transport.pause(()=>{i||this.readyState!=="closed"&&(u(),this.setTransport(t),t.send([{type:"upgrade"}]),this.emitReserved("upgrade",t),t=null,this.upgrading=!1,this.flush())})}else{const C=new Error("probe error");C.transport=t.name,this.emitReserved("upgradeError",C)}}))};function r(){i||(i=!0,u(),t.close(),t=null)}const o=m=>{const C=new Error("probe error: "+m);C.transport=t.name,r(),this.emitReserved("upgradeError",C)};function a(){o("transport closed")}function c(){o("socket closed")}function p(m){t&&m.name!==t.name&&r()}const u=()=>{t.removeListener("open",n),t.removeListener("error",o),t.removeListener("close",a),this.off("close",c),this.off("upgrading",p)};t.once("open",n),t.once("error",o),t.once("close",a),this.once("close",c),this.once("upgrading",p),this._upgrades.indexOf("webtransport")!==-1&&e!=="webtransport"?this.setTimeoutFn(()=>{i||t.open()},200):t.open()}onHandshake(e){this._upgrades=this._filterUpgrades(e.upgrades),super.onHandshake(e)}_filterUpgrades(e){const t=[];for(let i=0;i<e.length;i++)~this.transports.indexOf(e[i])&&t.push(e[i]);return t}}let ut=class extends lt{constructor(e,t={}){const i=typeof e=="object"?e:t;(!i.transports||i.transports&&typeof i.transports[0]=="string")&&(i.transports=(i.transports||["polling","websocket","webtransport"]).map(n=>ot[n]).filter(n=>!!n)),super(e,i)}};function ft(s,e="",t){let i=s;t=t||typeof location<"u"&&location,s==null&&(s=t.protocol+"//"+t.host),typeof s=="string"&&(s.charAt(0)==="/"&&(s.charAt(1)==="/"?s=t.protocol+s:s=t.host+s),/^(https?|wss?):\/\//.test(s)||(typeof t<"u"?s=t.protocol+"//"+s:s="https://"+s),i=Y(s)),i.port||(/^(http|ws)$/.test(i.protocol)?i.port="80":/^(http|ws)s$/.test(i.protocol)&&(i.port="443")),i.path=i.path||"/";const r=i.host.indexOf(":")!==-1?"["+i.host+"]":i.host;return i.id=i.protocol+"://"+r+":"+i.port+e,i.href=i.protocol+"://"+r+(t&&t.port===i.port?"":":"+i.port),i}const pt=typeof ArrayBuffer=="function",mt=s=>typeof ArrayBuffer.isView=="function"?ArrayBuffer.isView(s):s.buffer instanceof ArrayBuffer,Re=Object.prototype.toString,gt=typeof Blob=="function"||typeof Blob<"u"&&Re.call(Blob)==="[object BlobConstructor]",yt=typeof File=="function"||typeof File<"u"&&Re.call(File)==="[object FileConstructor]";function ee(s){return pt&&(s instanceof ArrayBuffer||mt(s))||gt&&s instanceof Blob||yt&&s instanceof File}function D(s,e){if(!s||typeof s!="object")return!1;if(Array.isArray(s)){for(let t=0,i=s.length;t<i;t++)if(D(s[t]))return!0;return!1}if(ee(s))return!0;if(s.toJSON&&typeof s.toJSON=="function"&&arguments.length===1)return D(s.toJSON(),!0);for(const t in s)if(Object.prototype.hasOwnProperty.call(s,t)&&D(s[t]))return!0;return!1}function _t(s){const e=[],t=s.data,i=s;return i.data=J(t,e),i.attachments=e.length,{packet:i,buffers:e}}function J(s,e){if(!s)return s;if(ee(s)){const t={_placeholder:!0,num:e.length};return e.push(s),t}else if(Array.isArray(s)){const t=new Array(s.length);for(let i=0;i<s.length;i++)t[i]=J(s[i],e);return t}else if(typeof s=="object"&&!(s instanceof Date)){const t={};for(const i in s)Object.prototype.hasOwnProperty.call(s,i)&&(t[i]=J(s[i],e));return t}return s}function vt(s,e){return s.data=K(s.data,e),delete s.attachments,s}function K(s,e){if(!s)return s;if(s&&s._placeholder===!0){if(typeof s.num=="number"&&s.num>=0&&s.num<e.length)return e[s.num];throw new Error("illegal attachments")}else if(Array.isArray(s))for(let t=0;t<s.length;t++)s[t]=K(s[t],e);else if(typeof s=="object")for(const t in s)Object.prototype.hasOwnProperty.call(s,t)&&(s[t]=K(s[t],e));return s}const bt=["connect","connect_error","disconnect","disconnecting","newListener","removeListener"],wt=5;var h;(function(s){s[s.CONNECT=0]="CONNECT",s[s.DISCONNECT=1]="DISCONNECT",s[s.EVENT=2]="EVENT",s[s.ACK=3]="ACK",s[s.CONNECT_ERROR=4]="CONNECT_ERROR",s[s.BINARY_EVENT=5]="BINARY_EVENT",s[s.BINARY_ACK=6]="BINARY_ACK"})(h||(h={}));class Et{constructor(e){this.replacer=e}encode(e){return(e.type===h.EVENT||e.type===h.ACK)&&D(e)?this.encodeAsBinary({type:e.type===h.EVENT?h.BINARY_EVENT:h.BINARY_ACK,nsp:e.nsp,data:e.data,id:e.id}):[this.encodeAsString(e)]}encodeAsString(e){let t=""+e.type;return(e.type===h.BINARY_EVENT||e.type===h.BINARY_ACK)&&(t+=e.attachments+"-"),e.nsp&&e.nsp!=="/"&&(t+=e.nsp+","),e.id!=null&&(t+=e.id),e.data!=null&&(t+=JSON.stringify(e.data,this.replacer)),t}encodeAsBinary(e){const t=_t(e),i=this.encodeAsString(t.packet),n=t.buffers;return n.unshift(i),n}}function le(s){return Object.prototype.toString.call(s)==="[object Object]"}class te extends l{constructor(e){super(),this.reviver=e}add(e){let t;if(typeof e=="string"){if(this.reconstructor)throw new Error("got plaintext data when reconstructing a packet");t=this.decodeString(e);const i=t.type===h.BINARY_EVENT;i||t.type===h.BINARY_ACK?(t.type=i?h.EVENT:h.ACK,this.reconstructor=new Ct(t),t.attachments===0&&super.emitReserved("decoded",t)):super.emitReserved("decoded",t)}else if(ee(e)||e.base64)if(this.reconstructor)t=this.reconstructor.takeBinaryData(e),t&&(this.reconstructor=null,super.emitReserved("decoded",t));else throw new Error("got binary data when not reconstructing a packet");else throw new Error("Unknown type: "+e)}decodeString(e){let t=0;const i={type:Number(e.charAt(0))};if(h[i.type]===void 0)throw new Error("unknown packet type "+i.type);if(i.type===h.BINARY_EVENT||i.type===h.BINARY_ACK){const r=t+1;for(;e.charAt(++t)!=="-"&&t!=e.length;);const o=e.substring(r,t);if(o!=Number(o)||e.charAt(t)!=="-")throw new Error("Illegal attachments");i.attachments=Number(o)}if(e.charAt(t+1)==="/"){const r=t+1;for(;++t&&!(e.charAt(t)===","||t===e.length););i.nsp=e.substring(r,t)}else i.nsp="/";const n=e.charAt(t+1);if(n!==""&&Number(n)==n){const r=t+1;for(;++t;){const o=e.charAt(t);if(o==null||Number(o)!=o){--t;break}if(t===e.length)break}i.id=Number(e.substring(r,t+1))}if(e.charAt(++t)){const r=this.tryParse(e.substr(t));if(te.isPayloadValid(i.type,r))i.data=r;else throw new Error("invalid payload")}return i}tryParse(e){try{return JSON.parse(e,this.reviver)}catch{return!1}}static isPayloadValid(e,t){switch(e){case h.CONNECT:return le(t);case h.DISCONNECT:return t===void 0;case h.CONNECT_ERROR:return typeof t=="string"||le(t);case h.EVENT:case h.BINARY_EVENT:return Array.isArray(t)&&(typeof t[0]=="number"||typeof t[0]=="string"&&bt.indexOf(t[0])===-1);case h.ACK:case h.BINARY_ACK:return Array.isArray(t)}}destroy(){this.reconstructor&&(this.reconstructor.finishedReconstruction(),this.reconstructor=null)}}class Ct{constructor(e){this.packet=e,this.buffers=[],this.reconPack=e}takeBinaryData(e){if(this.buffers.push(e),this.buffers.length===this.reconPack.attachments){const t=vt(this.reconPack,this.buffers);return this.finishedReconstruction(),t}return null}finishedReconstruction(){this.reconPack=null,this.buffers=[]}}const kt=Object.freeze(Object.defineProperty({__proto__:null,Decoder:te,Encoder:Et,get PacketType(){return h},protocol:wt},Symbol.toStringTag,{value:"Module"}));function _(s,e,t){return s.on(e,t),function(){s.off(e,t)}}const Rt=Object.freeze({connect:1,connect_error:1,disconnect:1,disconnecting:1,newListener:1,removeListener:1});class Te extends l{constructor(e,t,i){super(),this.connected=!1,this.recovered=!1,this.receiveBuffer=[],this.sendBuffer=[],this._queue=[],this._queueSeq=0,this.ids=0,this.acks={},this.flags={},this.io=e,this.nsp=t,i&&i.auth&&(this.auth=i.auth),this._opts=Object.assign({},i),this.io._autoConnect&&this.open()}get disconnected(){return!this.connected}subEvents(){if(this.subs)return;const e=this.io;this.subs=[_(e,"open",this.onopen.bind(this)),_(e,"packet",this.onpacket.bind(this)),_(e,"error",this.onerror.bind(this)),_(e,"close",this.onclose.bind(this))]}get active(){return!!this.subs}connect(){return this.connected?this:(this.subEvents(),this.io._reconnecting||this.io.open(),this.io._readyState==="open"&&this.onopen(),this)}open(){return this.connect()}send(...e){return e.unshift("message"),this.emit.apply(this,e),this}emit(e,...t){var i,n,r;if(Rt.hasOwnProperty(e))throw new Error('"'+e.toString()+'" is a reserved event name');if(t.unshift(e),this._opts.retries&&!this.flags.fromQueue&&!this.flags.volatile)return this._addToQueue(t),this;const o={type:h.EVENT,data:t};if(o.options={},o.options.compress=this.flags.compress!==!1,typeof t[t.length-1]=="function"){const u=this.ids++,m=t.pop();this._registerAckCallback(u,m),o.id=u}const a=(n=(i=this.io.engine)===null||i===void 0?void 0:i.transport)===null||n===void 0?void 0:n.writable,c=this.connected&&!(!((r=this.io.engine)===null||r===void 0)&&r._hasPingExpired());return this.flags.volatile&&!a||(c?(this.notifyOutgoingListeners(o),this.packet(o)):this.sendBuffer.push(o)),this.flags={},this}_registerAckCallback(e,t){var i;const n=(i=this.flags.timeout)!==null&&i!==void 0?i:this._opts.ackTimeout;if(n===void 0){this.acks[e]=t;return}const r=this.io.setTimeoutFn(()=>{delete this.acks[e];for(let a=0;a<this.sendBuffer.length;a++)this.sendBuffer[a].id===e&&this.sendBuffer.splice(a,1);t.call(this,new Error("operation has timed out"))},n),o=(...a)=>{this.io.clearTimeoutFn(r),t.apply(this,a)};o.withError=!0,this.acks[e]=o}emitWithAck(e,...t){return new Promise((i,n)=>{const r=(o,a)=>o?n(o):i(a);r.withError=!0,t.push(r),this.emit(e,...t)})}_addToQueue(e){let t;typeof e[e.length-1]=="function"&&(t=e.pop());const i={id:this._queueSeq++,tryCount:0,pending:!1,args:e,flags:Object.assign({fromQueue:!0},this.flags)};e.push((n,...r)=>i!==this._queue[0]?void 0:(n!==null?i.tryCount>this._opts.retries&&(this._queue.shift(),t&&t(n)):(this._queue.shift(),t&&t(null,...r)),i.pending=!1,this._drainQueue())),this._queue.push(i),this._drainQueue()}_drainQueue(e=!1){if(!this.connected||this._queue.length===0)return;const t=this._queue[0];t.pending&&!e||(t.pending=!0,t.tryCount++,this.flags=t.flags,this.emit.apply(this,t.args))}packet(e){e.nsp=this.nsp,this.io._packet(e)}onopen(){typeof this.auth=="function"?this.auth(e=>{this._sendConnectPacket(e)}):this._sendConnectPacket(this.auth)}_sendConnectPacket(e){this.packet({type:h.CONNECT,data:this._pid?Object.assign({pid:this._pid,offset:this._lastOffset},e):e})}onerror(e){this.connected||this.emitReserved("connect_error",e)}onclose(e,t){this.connected=!1,delete this.id,this.emitReserved("disconnect",e,t),this._clearAcks()}_clearAcks(){Object.keys(this.acks).forEach(e=>{if(!this.sendBuffer.some(i=>String(i.id)===e)){const i=this.acks[e];delete this.acks[e],i.withError&&i.call(this,new Error("socket has been disconnected"))}})}onpacket(e){if(e.nsp===this.nsp)switch(e.type){case h.CONNECT:e.data&&e.data.sid?this.onconnect(e.data.sid,e.data.pid):this.emitReserved("connect_error",new Error("It seems you are trying to reach a Socket.IO server in v2.x with a v3.x client, but they are not compatible (more information here: https://socket.io/docs/v3/migrating-from-2-x-to-3-0/)"));break;case h.EVENT:case h.BINARY_EVENT:this.onevent(e);break;case h.ACK:case h.BINARY_ACK:this.onack(e);break;case h.DISCONNECT:this.ondisconnect();break;case h.CONNECT_ERROR:this.destroy();const i=new Error(e.data.message);i.data=e.data.data,this.emitReserved("connect_error",i);break}}onevent(e){const t=e.data||[];e.id!=null&&t.push(this.ack(e.id)),this.connected?this.emitEvent(t):this.receiveBuffer.push(Object.freeze(t))}emitEvent(e){if(this._anyListeners&&this._anyListeners.length){const t=this._anyListeners.slice();for(const i of t)i.apply(this,e)}super.emit.apply(this,e),this._pid&&e.length&&typeof e[e.length-1]=="string"&&(this._lastOffset=e[e.length-1])}ack(e){const t=this;let i=!1;return function(...n){i||(i=!0,t.packet({type:h.ACK,id:e,data:n}))}}onack(e){const t=this.acks[e.id];typeof t=="function"&&(delete this.acks[e.id],t.withError&&e.data.unshift(null),t.apply(this,e.data))}onconnect(e,t){this.id=e,this.recovered=t&&this._pid===t,this._pid=t,this.connected=!0,this.emitBuffered(),this.emitReserved("connect"),this._drainQueue(!0)}emitBuffered(){this.receiveBuffer.forEach(e=>this.emitEvent(e)),this.receiveBuffer=[],this.sendBuffer.forEach(e=>{this.notifyOutgoingListeners(e),this.packet(e)}),this.sendBuffer=[]}ondisconnect(){this.destroy(),this.onclose("io server disconnect")}destroy(){this.subs&&(this.subs.forEach(e=>e()),this.subs=void 0),this.io._destroy(this)}disconnect(){return this.connected&&this.packet({type:h.DISCONNECT}),this.destroy(),this.connected&&this.onclose("io client disconnect"),this}close(){return this.disconnect()}compress(e){return this.flags.compress=e,this}get volatile(){return this.flags.volatile=!0,this}timeout(e){return this.flags.timeout=e,this}onAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.push(e),this}prependAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.unshift(e),this}offAny(e){if(!this._anyListeners)return this;if(e){const t=this._anyListeners;for(let i=0;i<t.length;i++)if(e===t[i])return t.splice(i,1),this}else this._anyListeners=[];return this}listenersAny(){return this._anyListeners||[]}onAnyOutgoing(e){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.push(e),this}prependAnyOutgoing(e){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.unshift(e),this}offAnyOutgoing(e){if(!this._anyOutgoingListeners)return this;if(e){const t=this._anyOutgoingListeners;for(let i=0;i<t.length;i++)if(e===t[i])return t.splice(i,1),this}else this._anyOutgoingListeners=[];return this}listenersAnyOutgoing(){return this._anyOutgoingListeners||[]}notifyOutgoingListeners(e){if(this._anyOutgoingListeners&&this._anyOutgoingListeners.length){const t=this._anyOutgoingListeners.slice();for(const i of t)i.apply(this,e.data)}}}function T(s){s=s||{},this.ms=s.min||100,this.max=s.max||1e4,this.factor=s.factor||2,this.jitter=s.jitter>0&&s.jitter<=1?s.jitter:0,this.attempts=0}T.prototype.duration=function(){var s=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var e=Math.random(),t=Math.floor(e*this.jitter*s);s=(Math.floor(e*10)&1)==0?s-t:s+t}return Math.min(s,this.max)|0};T.prototype.reset=function(){this.attempts=0};T.prototype.setMin=function(s){this.ms=s};T.prototype.setMax=function(s){this.max=s};T.prototype.setJitter=function(s){this.jitter=s};class X extends l{constructor(e,t){var i;super(),this.nsps={},this.subs=[],e&&typeof e=="object"&&(t=e,e=void 0),t=t||{},t.path=t.path||"/socket.io",this.opts=t,H(this,t),this.reconnection(t.reconnection!==!1),this.reconnectionAttempts(t.reconnectionAttempts||1/0),this.reconnectionDelay(t.reconnectionDelay||1e3),this.reconnectionDelayMax(t.reconnectionDelayMax||5e3),this.randomizationFactor((i=t.randomizationFactor)!==null&&i!==void 0?i:.5),this.backoff=new T({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()}),this.timeout(t.timeout==null?2e4:t.timeout),this._readyState="closed",this.uri=e;const n=t.parser||kt;this.encoder=new n.Encoder,this.decoder=new n.Decoder,this._autoConnect=t.autoConnect!==!1,this._autoConnect&&this.open()}reconnection(e){return arguments.length?(this._reconnection=!!e,e||(this.skipReconnect=!0),this):this._reconnection}reconnectionAttempts(e){return e===void 0?this._reconnectionAttempts:(this._reconnectionAttempts=e,this)}reconnectionDelay(e){var t;return e===void 0?this._reconnectionDelay:(this._reconnectionDelay=e,(t=this.backoff)===null||t===void 0||t.setMin(e),this)}randomizationFactor(e){var t;return e===void 0?this._randomizationFactor:(this._randomizationFactor=e,(t=this.backoff)===null||t===void 0||t.setJitter(e),this)}reconnectionDelayMax(e){var t;return e===void 0?this._reconnectionDelayMax:(this._reconnectionDelayMax=e,(t=this.backoff)===null||t===void 0||t.setMax(e),this)}timeout(e){return arguments.length?(this._timeout=e,this):this._timeout}maybeReconnectOnOpen(){!this._reconnecting&&this._reconnection&&this.backoff.attempts===0&&this.reconnect()}open(e){if(~this._readyState.indexOf("open"))return this;this.engine=new ut(this.uri,this.opts);const t=this.engine,i=this;this._readyState="opening",this.skipReconnect=!1;const n=_(t,"open",function(){i.onopen(),e&&e()}),r=a=>{this.cleanup(),this._readyState="closed",this.emitReserved("error",a),e?e(a):this.maybeReconnectOnOpen()},o=_(t,"error",r);if(this._timeout!==!1){const a=this._timeout,c=this.setTimeoutFn(()=>{n(),r(new Error("timeout")),t.close()},a);this.opts.autoUnref&&c.unref(),this.subs.push(()=>{this.clearTimeoutFn(c)})}return this.subs.push(n),this.subs.push(o),this}connect(e){return this.open(e)}onopen(){this.cleanup(),this._readyState="open",this.emitReserved("open");const e=this.engine;this.subs.push(_(e,"ping",this.onping.bind(this)),_(e,"data",this.ondata.bind(this)),_(e,"error",this.onerror.bind(this)),_(e,"close",this.onclose.bind(this)),_(this.decoder,"decoded",this.ondecoded.bind(this)))}onping(){this.emitReserved("ping")}ondata(e){try{this.decoder.add(e)}catch(t){this.onclose("parse error",t)}}ondecoded(e){F(()=>{this.emitReserved("packet",e)},this.setTimeoutFn)}onerror(e){this.emitReserved("error",e)}socket(e,t){let i=this.nsps[e];return i?this._autoConnect&&!i.active&&i.connect():(i=new Te(this,e,t),this.nsps[e]=i),i}_destroy(e){const t=Object.keys(this.nsps);for(const i of t)if(this.nsps[i].active)return;this._close()}_packet(e){const t=this.encoder.encode(e);for(let i=0;i<t.length;i++)this.engine.write(t[i],e.options)}cleanup(){this.subs.forEach(e=>e()),this.subs.length=0,this.decoder.destroy()}_close(){this.skipReconnect=!0,this._reconnecting=!1,this.onclose("forced close")}disconnect(){return this._close()}onclose(e,t){var i;this.cleanup(),(i=this.engine)===null||i===void 0||i.close(),this.backoff.reset(),this._readyState="closed",this.emitReserved("close",e,t),this._reconnection&&!this.skipReconnect&&this.reconnect()}reconnect(){if(this._reconnecting||this.skipReconnect)return this;const e=this;if(this.backoff.attempts>=this._reconnectionAttempts)this.backoff.reset(),this.emitReserved("reconnect_failed"),this._reconnecting=!1;else{const t=this.backoff.duration();this._reconnecting=!0;const i=this.setTimeoutFn(()=>{e.skipReconnect||(this.emitReserved("reconnect_attempt",e.backoff.attempts),!e.skipReconnect&&e.open(n=>{n?(e._reconnecting=!1,e.reconnect(),this.emitReserved("reconnect_error",n)):e.onreconnect()}))},t);this.opts.autoUnref&&i.unref(),this.subs.push(()=>{this.clearTimeoutFn(i)})}}onreconnect(){const e=this.backoff.attempts;this._reconnecting=!1,this.backoff.reset(),this.emitReserved("reconnect",e)}}const S={};function q(s,e){typeof s=="object"&&(e=s,s=void 0),e=e||{};const t=ft(s,e.path||"/socket.io"),i=t.source,n=t.id,r=t.path,o=S[n]&&r in S[n].nsps,a=e.forceNew||e["force new connection"]||e.multiplex===!1||o;let c;return a?c=new X(i,e):(S[n]||(S[n]=new X(i,e)),c=S[n]),t.query&&!e.query&&(e.query=t.queryKey),c.socket(t.path,e)}Object.assign(q,{Manager:X,Socket:Te,io:q,connect:q});/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */var g=function(){return g=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++){t=arguments[i];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])}return e},g.apply(this,arguments)},Tt=function(){function s(e){this.options=e,this.listeners={}}return s.prototype.on=function(e,t){var i=this.listeners[e]||[];this.listeners[e]=i.concat([t])},s.prototype.triggerEvent=function(e,t){var i=this,n=this.listeners[e]||[];n.forEach(function(r){return r({target:i,event:t})})},s}(),R;(function(s){s[s.Add=0]="Add",s[s.Remove=1]="Remove"})(R||(R={}));var Lt=function(){function s(){this.notifications=[]}return s.prototype.push=function(e){this.notifications.push(e),this.updateFn(e,R.Add,this.notifications)},s.prototype.splice=function(e,t){var i=this.notifications.splice(e,t)[0];return this.updateFn(i,R.Remove,this.notifications),i},s.prototype.indexOf=function(e){return this.notifications.indexOf(e)},s.prototype.onUpdate=function(e){this.updateFn=e},s}(),w;(function(s){s.Dismiss="dismiss",s.Click="click"})(w||(w={}));var ue={types:[{type:"success",className:"notyf__toast--success",backgroundColor:"#3dc763",icon:{className:"notyf__icon--success",tagName:"i"}},{type:"error",className:"notyf__toast--error",backgroundColor:"#ed3d3d",icon:{className:"notyf__icon--error",tagName:"i"}}],duration:2e3,ripple:!0,position:{x:"right",y:"bottom"},dismissible:!1},St=function(){function s(){this.notifications=[],this.events={},this.X_POSITION_FLEX_MAP={left:"flex-start",center:"center",right:"flex-end"},this.Y_POSITION_FLEX_MAP={top:"flex-start",center:"center",bottom:"flex-end"};var e=document.createDocumentFragment(),t=this._createHTMLElement({tagName:"div",className:"notyf"});e.appendChild(t),document.body.appendChild(e),this.container=t,this.animationEndEventName=this._getAnimationEndEventName(),this._createA11yContainer()}return s.prototype.on=function(e,t){var i;this.events=g(g({},this.events),(i={},i[e]=t,i))},s.prototype.update=function(e,t){t===R.Add?this.addNotification(e):t===R.Remove&&this.removeNotification(e)},s.prototype.removeNotification=function(e){var t=this,i=this._popRenderedNotification(e),n;if(i){n=i.node,n.classList.add("notyf__toast--disappear");var r;n.addEventListener(this.animationEndEventName,r=function(o){o.target===n&&(n.removeEventListener(t.animationEndEventName,r),t.container.removeChild(n))})}},s.prototype.addNotification=function(e){var t=this._renderNotification(e);this.notifications.push({notification:e,node:t}),this._announce(e.options.message||"Notification")},s.prototype._renderNotification=function(e){var t,i=this._buildNotificationCard(e),n=e.options.className;return n&&(t=i.classList).add.apply(t,n.split(" ")),this.container.appendChild(i),i},s.prototype._popRenderedNotification=function(e){for(var t=-1,i=0;i<this.notifications.length&&t<0;i++)this.notifications[i].notification===e&&(t=i);if(t!==-1)return this.notifications.splice(t,1)[0]},s.prototype.getXPosition=function(e){var t;return((t=e==null?void 0:e.position)===null||t===void 0?void 0:t.x)||"right"},s.prototype.getYPosition=function(e){var t;return((t=e==null?void 0:e.position)===null||t===void 0?void 0:t.y)||"bottom"},s.prototype.adjustContainerAlignment=function(e){var t=this.X_POSITION_FLEX_MAP[this.getXPosition(e)],i=this.Y_POSITION_FLEX_MAP[this.getYPosition(e)],n=this.container.style;n.setProperty("justify-content",i),n.setProperty("align-items",t)},s.prototype._buildNotificationCard=function(e){var t=this,i=e.options,n=i.icon;this.adjustContainerAlignment(i);var r=this._createHTMLElement({tagName:"div",className:"notyf__toast"}),o=this._createHTMLElement({tagName:"div",className:"notyf__ripple"}),a=this._createHTMLElement({tagName:"div",className:"notyf__wrapper"}),c=this._createHTMLElement({tagName:"div",className:"notyf__message"});c.innerHTML=i.message||"";var p=i.background||i.backgroundColor;if(n){var u=this._createHTMLElement({tagName:"div",className:"notyf__icon"});if((typeof n=="string"||n instanceof String)&&(u.innerHTML=new String(n).valueOf()),typeof n=="object"){var m=n.tagName,C=m===void 0?"i":m,Le=n.className,Se=n.text,ie=n.color,se=ie===void 0?p:ie,ne=this._createHTMLElement({tagName:C,className:Le,text:Se});se&&(ne.style.color=se),u.appendChild(ne)}a.appendChild(u)}if(a.appendChild(c),r.appendChild(a),p&&(i.ripple?(o.style.background=p,r.appendChild(o)):r.style.background=p),i.dismissible){var re=this._createHTMLElement({tagName:"div",className:"notyf__dismiss"}),oe=this._createHTMLElement({tagName:"button",className:"notyf__dismiss-btn"});re.appendChild(oe),a.appendChild(re),r.classList.add("notyf__toast--dismissible"),oe.addEventListener("click",function(N){var L,k;(k=(L=t.events)[w.Dismiss])===null||k===void 0||k.call(L,{target:e,event:N}),N.stopPropagation()})}r.addEventListener("click",function(N){var L,k;return(k=(L=t.events)[w.Click])===null||k===void 0?void 0:k.call(L,{target:e,event:N})});var Ae=this.getYPosition(i)==="top"?"upper":"lower";return r.classList.add("notyf__toast--"+Ae),r},s.prototype._createHTMLElement=function(e){var t=e.tagName,i=e.className,n=e.text,r=document.createElement(t);return i&&(r.className=i),r.textContent=n||null,r},s.prototype._createA11yContainer=function(){var e=this._createHTMLElement({tagName:"div",className:"notyf-announcer"});e.setAttribute("aria-atomic","true"),e.setAttribute("aria-live","polite"),e.style.border="0",e.style.clip="rect(0 0 0 0)",e.style.height="1px",e.style.margin="-1px",e.style.overflow="hidden",e.style.padding="0",e.style.position="absolute",e.style.width="1px",e.style.outline="0",document.body.appendChild(e),this.a11yContainer=e},s.prototype._announce=function(e){var t=this;this.a11yContainer.textContent="",setTimeout(function(){t.a11yContainer.textContent=e},100)},s.prototype._getAnimationEndEventName=function(){var e=document.createElement("_fake"),t={MozTransition:"animationend",OTransition:"oAnimationEnd",WebkitTransition:"webkitAnimationEnd",transition:"animationend"},i;for(i in t)if(e.style[i]!==void 0)return t[i];return"animationend"},s}(),At=function(){function s(e){var t=this;this.dismiss=this._removeNotification,this.notifications=new Lt,this.view=new St;var i=this.registerTypes(e);this.options=g(g({},ue),e),this.options.types=i,this.notifications.onUpdate(function(n,r){return t.view.update(n,r)}),this.view.on(w.Dismiss,function(n){var r=n.target,o=n.event;t._removeNotification(r),r.triggerEvent(w.Dismiss,o)}),this.view.on(w.Click,function(n){var r=n.target,o=n.event;return r.triggerEvent(w.Click,o)})}return s.prototype.error=function(e){var t=this.normalizeOptions("error",e);return this.open(t)},s.prototype.success=function(e){var t=this.normalizeOptions("success",e);return this.open(t)},s.prototype.open=function(e){var t=this.options.types.find(function(r){var o=r.type;return o===e.type})||{},i=g(g({},t),e);this.assignProps(["ripple","position","dismissible"],i);var n=new Tt(i);return this._pushNotification(n),n},s.prototype.dismissAll=function(){for(;this.notifications.splice(0,1););},s.prototype.assignProps=function(e,t){var i=this;e.forEach(function(n){t[n]=t[n]==null?i.options[n]:t[n]})},s.prototype._pushNotification=function(e){var t=this;this.notifications.push(e);var i=e.options.duration!==void 0?e.options.duration:this.options.duration;i&&setTimeout(function(){return t._removeNotification(e)},i)},s.prototype._removeNotification=function(e){var t=this.notifications.indexOf(e);t!==-1&&this.notifications.splice(t,1)},s.prototype.normalizeOptions=function(e,t){var i={type:e};return typeof t=="string"?i.message=t:typeof t=="object"&&(i=g(g({},i),t)),i},s.prototype.registerTypes=function(e){var t=(e&&e.types||[]).slice(),i=ue.types.map(function(n){var r=-1;t.forEach(function(a,c){a.type===n.type&&(r=c)});var o=r!==-1?t.splice(r,1)[0]:{};return g(g({},n),o)});return i.concat(t)},s}();class Nt{constructor(){d(this,"_room");d(this,"_user");d(this,"_isMobile");d(this,"_isLeftSidebarOpen");d(this,"_isRightSidebarOpen");d(this,"_isRoomLoaded");this._room={id:"",name:"",members:[],messages:[]},this._user=null,this._isMobile=window.innerWidth<1024,this._isLeftSidebarOpen=!1,this._isRightSidebarOpen=!1,this._isRoomLoaded=!1}get room(){return this._room}get user(){return this._user}get isMobile(){return this._isMobile}get isLeftSidebarOpen(){return this._isLeftSidebarOpen}get isRightSidebarOpen(){return this._isRightSidebarOpen}get isRoomLoaded(){return this._isRoomLoaded}setRoom(e){this._room={...this._room,...e}}setUser(e){this._user=e}setRoomMembers(e){this._room.members=[...new Map(e.map(t=>[t.id,t])).values()].sort((t,i)=>t.joinedAt-i.joinedAt)}addRoomMember(e){this.setRoomMembers([...this._room.members,e])}updateRoomMember(e,t){this._room.members=this._room.members.map(i=>i.id===e?{...i,...t}:i)}getMember(e){return this._room.members.find(t=>t.id===e)}addMessage(e){this._room.messages.push(e)}setRoomLoaded(e){this._isRoomLoaded=e}setMobile(e){this._isMobile=e}toggleLeftSidebar(){this._isLeftSidebarOpen=!this._isLeftSidebarOpen}toggleRightSidebar(){this._isRightSidebarOpen=!this._isRightSidebarOpen}setMobileLeftSidebarOpen(e){this._isLeftSidebarOpen=e}setMobileRightSidebarOpen(e){this._isRightSidebarOpen=e}}const B=["from-blue-500 to-purple-500","from-green-500 to-teal-500","from-yellow-500 to-orange-500","from-pink-500 to-rose-500","from-indigo-500 to-blue-500","from-red-500 to-pink-500","from-teal-500 to-cyan-500","from-purple-500 to-indigo-500","from-orange-500 to-red-500","from-cyan-500 to-blue-500"];class xt{constructor(e,t){d(this,"store");d(this,"notyf");this.store=e,this.notyf=t}initialize(){this.initializeRoomUI(),this.updateUsersList(),this.updateChatMessages()}initializeRoomUI(){this.removeLoadingOverlay();const e=this.getUIElements();this.store.setMobile(window.innerWidth<1024),this.updateLayout(),window.addEventListener("resize",()=>{this.store.setMobile(window.innerWidth<1024),this.updateLayout()}),e.toggleLeft.addEventListener("click",()=>this.store.toggleLeftSidebar()),e.toggleRight.addEventListener("click",()=>this.store.toggleRightSidebar()),e.floatingLeftToggle.addEventListener("click",()=>this.store.toggleLeftSidebar()),e.floatingRightToggle.addEventListener("click",()=>this.store.toggleRightSidebar())}getUIElements(){return{leftSidebar:document.getElementById("leftSidebar"),rightSidebar:document.getElementById("rightSidebar"),toggleLeft:document.getElementById("toggleLeft"),toggleRight:document.getElementById("toggleRight"),floatingLeftToggle:document.getElementById("floatingLeftToggle"),floatingRightToggle:document.getElementById("floatingRightToggle"),roomNameText:document.getElementById("roomName"),roomMembersCount:document.getElementById("roomMembersCount"),roomUsersList:document.getElementById("roomUsersList"),chatMessages:document.getElementById("chatMessages"),shareBtn:document.getElementById("shareBtn"),endCallBtn:document.getElementById("endCallBtn"),chatForm:document.getElementById("chatForm"),chatInput:document.getElementById("chatInput"),muteBtn:document.getElementById("muteBtn"),joinAudioChat:document.getElementById("joinAudioChat"),joinAudioChatHoverText:document.getElementById("joinAudioChatHoverText")}}updateLayout(){const e=this.getUIElements(),{isMobile:t,isLeftSidebarOpen:i,isRightSidebarOpen:n}=this.store;t?this.handleMobileLayout(e,i,n):this.handleDesktopLayout(e,i,n)}handleMobileLayout(e,t,i){if(t?(e.leftSidebar.classList.add("sidebar-mobile"),e.leftSidebar.classList.remove("open"),e.floatingLeftToggle.classList.remove("hidden")):(e.leftSidebar.classList.add("sidebar-mobile","open"),e.floatingLeftToggle.classList.add("hidden")),i?(e.rightSidebar.classList.add("sidebar-mobile-right"),e.rightSidebar.classList.remove("open"),e.floatingRightToggle.classList.remove("hidden")):(e.rightSidebar.classList.add("sidebar-mobile-right","open"),e.floatingRightToggle.classList.add("hidden")),!t||!i){if(!document.getElementById("mobileOverlay")){const n=document.createElement("div");n.id="mobileOverlay",n.className="fixed inset-0 bg-black/50 z-30 lg:hidden",n.addEventListener("click",()=>{this.store.setMobileLeftSidebarOpen(!0),this.store.setMobileRightSidebarOpen(!0),this.updateLayout()}),document.body.appendChild(n)}}else{const n=document.getElementById("mobileOverlay");n&&n.remove()}}handleDesktopLayout(e,t,i){e.leftSidebar.classList.remove("sidebar-mobile","sidebar-mobile-right","open"),e.rightSidebar.classList.remove("sidebar-mobile","sidebar-mobile-right","open"),t?(e.leftSidebar.style.width="0px",e.leftSidebar.style.minWidth="0px",e.leftSidebar.style.overflow="hidden",e.floatingLeftToggle.classList.remove("hidden")):(e.leftSidebar.style.width="320px",e.leftSidebar.style.minWidth="320px",e.leftSidebar.style.overflow="visible",e.floatingLeftToggle.classList.add("hidden")),i?(e.rightSidebar.style.width="0px",e.rightSidebar.style.minWidth="0px",e.rightSidebar.style.overflow="hidden",e.floatingRightToggle.classList.remove("hidden")):(e.rightSidebar.style.width="320px",e.rightSidebar.style.minWidth="320px",e.rightSidebar.style.overflow="visible",e.floatingRightToggle.classList.add("hidden"));const n=document.getElementById("mobileOverlay");n&&n.remove()}updateUsersList(){const e=this.getUIElements();!e.roomNameText||!e.roomMembersCount||!e.roomUsersList||(e.roomNameText.textContent=this.store.room.name,e.roomMembersCount.textContent=`${this.store.room.members.length} participant${this.store.room.members.length===1?"":"s"}`,e.roomUsersList.innerHTML=this.store.room.members.map((t,i)=>this.createUserListItem(t,i)).join(""))}createUserListItem(e,t){const i=B[t%B.length],n=e.socketId.length>0,r=e.isMuted,o=e.isJoinedInAudioChat;return`
      <div class="flex items-center space-x-3 p-2 rounded-lg hover:bg-gray-700/30 transition-colors">
        <div class="relative">
          <div class="w-8 h-8 rounded-full bg-gradient-to-r ${i} flex items-center justify-center text-white font-medium">
            ${e.userName[0]}
          </div>
          <div class="absolute -bottom-1 -right-1 w-3 h-3 ${n?"bg-green-500":"bg-gray-500"} border-2 border-gray-800 rounded-full"></div>
        </div>
        <div class="flex-1">
          <p class="text-sm font-medium">${e.userName}</p>
          <p class="text-xs text-gray-400">${e.isHost?"Host":""}</p>
        </div>
        ${n&&o?`
        <div class="flex items-center space-x-2">
          ${r?`<svg class="w-4 h-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path>
                  <line x1="17" y1="7" x2="7" y2="17" stroke="currentColor" stroke-width="2"></line>
                </svg>`:`<div class="audio-bars">
                  <div class="audio-bar" style="height: 8px"></div>
                  <div class="audio-bar" style="height: 12px"></div>
                  <div class="audio-bar" style="height: 6px"></div>
                  <div class="audio-bar" style="height: 10px"></div>
                </div>`}
        </div>`:""}
      </div>
    `}updateChatMessages(){const e=document.getElementById("chatMessages");if(e){if(!this.store.room.messages.length){e.innerHTML=`
        <div class="flex items-center justify-center h-full">
          <p class="text-gray-500">No messages yet</p>
        </div>
      `;return}e.innerHTML=this.store.room.messages.map(t=>this.createMessageElement(t)).join(""),e.scrollTop=e.scrollHeight}}createMessageElement(e){const t=this.store.room.members.findIndex(r=>r.id===e.senderId),i=this.store.room.members[t];return`
      <div class="chat-message">
        <div class="flex items-start space-x-3">
          <div class="relative">
            <div class="w-8 h-8 rounded-full bg-gradient-to-r ${B[t%B.length]} flex items-center justify-center text-white font-medium">
              ${i==null?void 0:i.userName[0]}
            </div>
          </div>
          <div>
            <div class="flex items-center space-x-2">
              <span class="text-sm font-medium text-blue-400">${i==null?void 0:i.userName}</span>
              <span class="text-xs text-gray-500">${this.formatMessageTimestamp(e.createdAt)}</span>
            </div>
            <p class="text-sm text-gray-300 mt-1">${e.content}</p>
          </div>
        </div>
      </div>
    `}formatMessageTimestamp(e){const t=new Date(e),n=Math.abs(new Date().getTime()-t.getTime()),r=Math.floor(n/(1e3*60*60*24)),o=t.getHours().toString().padStart(2,"0"),a=t.getMinutes().toString().padStart(2,"0"),c=`${o}:${a}`;if(r===0)return`Today at ${c}`;if(r===1)return`Yesterday at ${c}`;{const p=(t.getMonth()+1).toString().padStart(2,"0"),u=t.getDate().toString().padStart(2,"0"),m=t.getFullYear();return`${p}/${u}/${m} at ${c}`}}updateMuteButton(e){const i=this.getUIElements().muteBtn;i&&(e?i.innerHTML=`
        <svg class="w-4 h-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path>
          <line x1="17" y1="7" x2="7" y2="17" stroke="currentColor" stroke-width="2"></line>
        </svg>`:i.innerHTML=`
        <div class="audio-bars">
          <div class="audio-bar" style="height: 8px"></div>
          <div class="audio-bar" style="height: 12px"></div>
          <div class="audio-bar" style="height: 6px"></div>
          <div class="audio-bar" style="height: 10px"></div>
        </div>`)}audioChatControlButton(e){const t=this.getUIElements(),i=t.joinAudioChat,n=t.joinAudioChatHoverText;!i||!n||(e?(n.textContent="Leave Audio Chat",i.classList.add("bg-red-700","hover:bg-red-600"),i.classList.remove("bg-green-700","hover:bg-green-600")):(n.textContent="Join Audio Chat",i.classList.add("bg-green-700","hover:bg-green-600"),i.classList.remove("bg-red-700","hover:bg-red-600")))}showNotification(e,t){t==="success"?this.notyf.success({message:e,duration:2e3,dismissible:!0,position:{x:"center",y:"top"}}):t==="info"?this.notyf.success({message:e,duration:2e3,dismissible:!0,position:{x:"center",y:"top"},type:"custom",className:"bg-blue-500 text-white"}):t==="error"?this.notyf.error({message:e,duration:3e3,dismissible:!0,position:{x:"center",y:"top"}}):t==="warning"&&this.notyf.success({message:e,duration:3e3,dismissible:!0,position:{x:"center",y:"top"},type:"custom",className:"bg-orange-500 text-white"})}showError(e){this.notyf.error({message:e,duration:3e3,dismissible:!0,position:{x:"center",y:"top"}})}showLoadingError(e,t){const i=document.getElementById("error-text"),n=document.getElementById("error-description"),r=document.getElementById("loading-text");i&&n&&r&&(r.textContent="",i.textContent=e,n.textContent=t)}updateLoadingText(e){const t=document.getElementById("loading-text");t&&(t.textContent=e)}removeLoadingOverlay(){const e=document.getElementById("loading-overlay");e&&e.remove()}}class Ot{constructor(e,t,i,n){d(this,"peerConnections",new Map);d(this,"localStream",null);d(this,"socket");d(this,"store");d(this,"uiManager");d(this,"isMuted",!1);this.socket=e,this.store=t,this.uiManager=i,this.setupSocketListeners()}setupSocketListeners(){this.socket.on(f.RECEIVE_WEBRTC_OFFER,async({from:e,offer:t})=>{console.log(`Received WebRTC offer from ${e}`);const i=this.store.room.members.find(o=>o.socketId===e);if(!i){console.error("Connection not found");return}const n=await this.createPeerConnection(i.id);await n.setRemoteDescription(t);const r=await n.createAnswer();await n.setLocalDescription(r),console.log(`Sending WebRTC answer to ${i.id}`),this.socket.emit(f.SEND_WEBRTC_ANSWER,{to:i.id,answer:r,roomId:this.store.room.id})}),this.socket.on(f.RECEIVE_WEBRTC_ANSWER,async({from:e,answer:t})=>{console.log(`Received WebRTC answer from ${e}`);const i=this.store.room.members.find(r=>r.socketId===e);if(!i){console.error("Connection not found");return}const n=this.peerConnections.get(i.id);n&&await n.setRemoteDescription(t)}),this.socket.on(f.RECEIVE_WEBRTC_ICE_CANDIDATE,async({from:e,candidate:t})=>{console.log(`Received ICE candidate from ${e}`);const i=this.store.room.members.find(r=>r.socketId===e);if(!i){console.error("Connection not found");return}const n=this.peerConnections.get(i.id);n&&await n.addIceCandidate(t)}),this.socket.on(f.USER_JOINED_AUDIO_CHAT,({userId:e})=>{console.log(`User ${e} joined audio chat`);const t=this.store.room.members.find(i=>i.id===e);if(!t){console.error("Connection not found");return}this.store.room.members.forEach(i=>{i.id===e&&(i.isJoinedInAudioChat=!0)}),this.uiManager.showNotification(t.userName+" joined audio chat","info"),this.uiManager.updateUsersList()}),this.socket.on(f.USER_LEFT_AUDIO_CHAT,({userId:e})=>{console.log(`User ${e} left audio chat`);const t=this.store.room.members.find(i=>i.id===e);if(!t){console.error("Connection not found");return}this.store.room.members.forEach(i=>{i.id===e&&(i.isJoinedInAudioChat=!1)}),this.uiManager.showNotification(`User ${t.userName} left audio chat`,"warning"),this.uiManager.updateUsersList()})}async startAudioChat(){try{this.localStream=await navigator.mediaDevices.getUserMedia({audio:!0}),this.store.room.members.forEach(e=>{e.socketId&&e.socketId!==this.socket.id&&this.createPeerConnectionAndSendOffer(e.id)}),this.store.room.members.forEach(e=>{e.id===this.store.user.id&&(e.isJoinedInAudioChat=!0)}),this.uiManager.updateUsersList(),this.uiManager.audioChatControlButton(!0),this.uiManager.showNotification("Connected to audio chat","success"),this.socket.emit(f.JOIN_AUDIO_CHAT,{roomId:this.store.room.id})}catch(e){throw console.error("Error starting audio chat:",e),new Error("Failed to start audio chat: "+(e instanceof Error?e.message:"An unknown error occurred"))}}async createPeerConnectionAndSendOffer(e){const t=await this.createPeerConnection(e),i=await t.createOffer();await t.setLocalDescription(i),console.log(`Sending WebRTC offer to ${e}`),this.socket.emit(f.SEND_WEBRTC_OFFER,{to:e,offer:i,roomId:this.store.room.id})}async createPeerConnection(e){const t={iceServers:[{urls:"stun:stun.l.google.com:19302"}]},i=new RTCPeerConnection(t);return this.peerConnections.set(e,i),this.localStream&&this.localStream.getTracks().forEach(n=>{i.addTrack(n,this.localStream)}),this.bindPeerConnectionListeners(i,e),i}bindPeerConnectionListeners(e,t){e.ontrack=i=>{const n=i.streams[0];this.handleRemoteStream(t,n)},e.onicecandidate=i=>{i!=null&&i.candidate&&(console.log(`Sending ICE candidate to ${t}`),this.socket.emit(f.SEND_WEBRTC_ICE_CANDIDATE,{to:t,candidate:i.candidate,roomId:this.store.room.id}))}}handleRemoteStream(e,t){const i=new Audio;i.srcObject=t,i.autoplay=!0,console.log("received remote stream from",e,t)}stopAudioChat(){var e;(e=this.localStream)==null||e.getTracks().forEach(t=>t.stop()),this.localStream=null,this.peerConnections.forEach(t=>t.close()),this.peerConnections.clear(),this.store.room.members.forEach(t=>{t.id===this.store.user.id&&(t.isJoinedInAudioChat=!1)}),this.uiManager.updateUsersList(),this.uiManager.audioChatControlButton(!1),this.uiManager.showNotification("Disconnected from audio chat","warning"),this.socket.emit(f.LEAVE_AUDIO_CHAT,{roomId:this.store.room.id})}toggleMute(){if(!this.localStream)return this.uiManager.showNotification("You are not connected to any audio channel","warning"),!1;const e=this.localStream.getAudioTracks();return e.length===0?(this.uiManager.showNotification("No audio tracks found","warning"),!1):(this.isMuted=!this.isMuted,e.forEach(t=>{t.enabled=!this.isMuted}),this.store.room.members=this.store.room.members.map(t=>t.id===this.store.user.id?{...t,isMuted:this.isMuted}:t),this.uiManager.updateUsersList(),this.socket.emit(f.AUDIO_STATUS_CHANGED,{roomId:this.store.room.id,userId:this.store.user.id,isMuted:this.isMuted}),this.uiManager.showNotification(this.isMuted?"You are now muted":"You are now unmuted","info"),this.isMuted)}}class fe{static getCachedRoomId(){return localStorage.getItem(x.ROOM_ID)}static setCachedRoomId(e){localStorage.setItem(x.ROOM_ID,e)}static getCachedUserId(){return localStorage.getItem(x.USER_ID)}static setCachedUserId(e){localStorage.setItem(x.USER_ID,e)}}class Mt{constructor(){d(this,"socket",null);d(this,"webRTCManager",null);d(this,"uiManager");d(this,"store");d(this,"notyf");this.notyf=new At,this.store=new Nt,this.uiManager=new xt(this.store,this.notyf)}async initialize(){try{this.uiManager.updateLoadingText("Loading room..."),await this.loadRoom(),this.uiManager.updateLoadingText("Connecting to room..."),this.socket=await this.connectToRoom(),this.uiManager.initialize(),this.store.setRoomLoaded(!0),this.webRTCManager=new Ot(this.socket,this.store,this.uiManager,this.notyf),this.bindSocketListeners(),this.bindUIHandlers(),await this.webRTCManager.startAudioChat(),this.bindWebRTCControls()}catch(e){this.handleInitializationError(e)}}async loadRoom(){const e=new URLSearchParams(window.location.search),t=e.get(O.ROOM_ID),i=e.get(O.USER_ID);if(!t||!i)throw new Error("roomId or userId is missing in the URL");const n=await Oe(async()=>this.fetchRoomData(t));this.store.setRoom({...this.store.room,name:n.name,id:t,members:n.users,messages:n.messages}),fe.setCachedRoomId(t),fe.setCachedUserId(i)}async fetchRoomData(e){return await(await fetch(`https://streamlocal.onrender.com/api/room/${e}`)).json()}async connectToRoom(){return new Promise((e,t)=>{const i=new URLSearchParams(window.location.search),n=i.get(O.ROOM_ID),r=i.get(O.USER_ID);if(!n||!r){t(new Error("roomId or userId is missing in the URL"));return}const o=q("https://streamlocal.onrender.com/");o.on("connect",()=>{o.emit(f.JOIN_ROOM,{roomId:n,userId:r},a=>{this.store.setUser(a),this.store.setRoomMembers([...this.store.room.members,a]),e(o)})}),o.on("connect_error",a=>{t(a)})})}bindSocketListeners(){this.socket&&(this.socket.on(f.ERROR,e=>{this.uiManager.showNotification(e??"Failed to perform last action","error")}),this.socket.on(f.USER_JOINED,e=>{this.store.addRoomMember(e),this.uiManager.updateUsersList(),this.uiManager.showNotification(`${e.userName} joined`,"info")}),this.socket.on(f.USER_LEFT,e=>{const t=this.store.getMember(e);t&&(this.store.updateRoomMember(e,{socketId:""}),this.uiManager.updateUsersList(),this.uiManager.showNotification(`${t.userName} left`,"warning"))}),this.socket.on(f.RECEIVE_MESSAGE,e=>{this.store.addMessage(e),this.uiManager.updateChatMessages()}),this.socket.on(f.USER_AUDIO_STATUS_CHANGED,({userId:e,isMuted:t})=>{this.store.updateRoomMember(e,{isMuted:t}),this.uiManager.updateUsersList()}))}bindUIHandlers(){const e=this.uiManager.getUIElements();e.chatForm.addEventListener("submit",t=>{var n;t.preventDefault();const i=e.chatInput.value;!i||!this.socket||(this.socket.emit(f.SEND_MESSAGE,{roomId:this.store.room.id,userId:(n=this.store.user)==null?void 0:n.id,content:i},r=>{this.store.addMessage(r),this.uiManager.updateChatMessages()}),e.chatInput.value="")}),e.shareBtn.addEventListener("click",()=>this.handleShareInviteLink()),e.endCallBtn.addEventListener("click",()=>this.handleLeaveRoom()),e.joinAudioChat.addEventListener("click",()=>{var i,n,r;if((i=this.store.room.members.find(o=>{var a;return o.id===((a=this.store.user)==null?void 0:a.id)}))==null?void 0:i.isJoinedInAudioChat){(n=this.webRTCManager)==null||n.stopAudioChat();return}(r=this.webRTCManager)==null||r.startAudioChat()})}handleShareInviteLink(){const e=new URL(window.location.href),t=e.searchParams.get("id"),n=`${e.origin.replace("/room.html","")}?id=${t}`;navigator.clipboard.writeText(n).then(()=>{this.uiManager.showNotification("Invite link copied to clipboard!","success")}).catch(r=>{console.error("Failed to copy link:",r),this.uiManager.showNotification("Failed to copy link to clipboard","error")})}handleLeaveRoom(){window.location.href="/"}bindWebRTCControls(){const e=document.getElementById("muteBtn");!e||!this.webRTCManager||e.addEventListener("click",()=>{var i;const t=(i=this.webRTCManager)==null?void 0:i.toggleMute();this.uiManager.updateMuteButton(t??!1)})}handleInitializationError(e){console.error(e);const t=e instanceof Error?e.message:"An unknown error occurred";this.store.isRoomLoaded?this.uiManager.showLoadingError("Failed to load room. Please try again.",t):this.uiManager.showNotification(t,"error")}}document.addEventListener("DOMContentLoaded",async()=>{await new Mt().initialize()});
